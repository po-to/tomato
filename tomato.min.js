var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};define(["require","exports"],function(t,e){"use strict";function i(t){return Object.keys(t).forEach(function(e){delete t[e]}),t}function o(e,i,n){var s,r;"string"!=typeof e?(r=e,s=e.getVPID()):(r=null,s=e);var a=g[s];if(a instanceof y)return a;if(a instanceof Promise){var h=i||function(t){},c=n||function(t){};return a.then(h,c),a}var u=function(t,e){delete g[s],n&&n(t),console.log(t),e(t)},l=function(t,e,n,r){var a=null;try{a=new t(e,(void 0),s)}catch(t){u(t,r)}a&&Promise.all(e.getSUBS().map(function(t){var e=t.getVPID();return g[e]&&t.setVPID(e+"#"+ ++d),o(t)})).then(function(t){return a&&a.init(t)}).then(function(){i&&i(a),n(a)}).catch(function(t){u(t,r)})},p=new Promise(function(e,i){var o=function(o){var n=o.getVPCON();n?t([n],function(t){l(t,o,e,i)},function(t){u(t,i)}):l(y,o,e,i)};r?o(r):t([s],function(t){r="string"==typeof t?C(t):t,o(r)},function(t){u(t,i)})});return g[s]=p,m.addItem(p,"load:"+s),p}function n(t,e,i){window.addEventListener?t.addEventListener(e,i,!1):t.attachEvent("on"+e,i)}function s(){var t=!!window.history.pushState,e=Date.now(),i="#undo@"+e,o="#redo@"+e,s=window.location.hash;s=s?s:"#";var r=!1;t?(window.history.replaceState("","back",i),window.history.pushState("","",s),window.history.pushState("","forward",o)):(window.location.replace(i),window.location.href=s,window.location.href=o);var a=function(t){window.setTimeout(function(){},0)};window.setTimeout(function(){n(window,"hashchange",function(t){if(console.log("hash",window.location.hash),console.log(t),r)return r=!1,a("historyReady"),!0}),r=!0,window.history.go(-1)},0)}function r(t){t.namespace&&(e.namespace=u=t.namespace),t.createVPView&&(C=t.createVPView),t.application&&(e.application=P=t.application,a(P)),t.renderer&&(t.renderer.__parse__||(t.renderer.__parse__=function(t,e){for(var i in t.data)t.hasOwnProperty(i)&&t[i]&&t[i].type==e&&(t[i]=this.__parse__(t[i]));return this[t.renderer](t.template,t.data)}),define("rendererManager",t.renderer))}function a(t){b!=t&&(b&&b.view.removeClass("pt-topDialog"),b=t,b.view.addClass("pt-topDialog"))}function h(){return b}function c(t){t=t}var d=0,u="po-to/tomato";e.namespace=u,e.TaskCountEvent={Added:"TaskCountEvent.Added",Completed:"TaskCountEvent.Completed",Busy:"TaskCountEvent.Busy",Free:"TaskCountEvent.Free"},e.VPresenterEvent={Installed:"CPresenterEvent.Installed",Uninstalled:"CPresenterEvent.Uninstalled",ChildAppended:"CPresenterEvent.ChildAppended",ChildRemoved:"CPresenterEvent.ChildRemoved"},e.VPresenterTransaction={AllowInstall:"AllowInstall"},e.DialogEvent={Focused:"DialogEvent.Focused",Blured:"DialogEvent.Blured",Closed:"DialogEvent.Closed"},e.CmdEvent={ItemSuccess:"CmdEvent.ItemSuccess",ItemFailure:"CmdEvent.ItemFailure",Failure:"CmdEvent.Failure",Success:"CmdEvent.Success",Complete:"CmdEvent.Complete",Overflow:"CmdEvent.Overflow"};var l=function(){function t(t,e,i){void 0===i&&(i=!1),this.name=t,this.data=e,this.bubbling=i}return t.prototype._setTarget=function(t){return this.target=t,this},t}();e.PEvent=l;var p=function(t){function e(e,i,o){void 0===i&&(i="tomato.PError");var n=t.call(this,e)||this;return n.name=e,n.note=i,n.data=o,n}return __extends(e,t),e.prototype.getNamespace=function(){return u},e}(Error);e.PError=p;var f=function(){function t(t){this.parent=t,this._handlers={}}return t.prototype.addListener=function(t,e){var i=this._handlers[t];return i||(this._handlers[t]=i=[]),i.push(e),this},t.prototype.removeListener=function(t,e){if(t){var o=this._handlers;if(o.propertyIsEnumerable(t)){var n=o[t];if(e){var s=n.indexOf(e);s>-1&&n.splice(s,1),0==n.length&&delete o[t]}else delete o[t]}}else i(this._handlers);return this},t.prototype.dispatch=function(t){t.target||t._setTarget(this);var e=this._handlers[t.name];if(e)for(var i=0,o=e.length;i<o;i++)e[i](t);return this.parent&&t.bubbling&&this.parent.dispatch(t),this},t.prototype.setParent=function(t){return this.parent=t,this},t}();e.PDispatcher=f;var _;!function(t){t[t.Free=0]="Free",t[t.Busy=1]="Busy"}(_=e.TaskCounterState||(e.TaskCounterState={}));var v=function(t){function i(e){var i=t.call(this)||this;return i.deferSecond=e,i.list=[],i.state=_.Free,i}return __extends(i,t),i.prototype.addItem=function(t,i){var o=this;return void 0===i&&(i=""),this.list.find(function(e){return e.promise===t})||(this.list.push({promise:t,note:i}),t.then(function(e){return o._completeItem(t)},function(e){return o._completeItem(t)}),this.dispatch(new l(e.TaskCountEvent.Added)),this._timer||(this._timer=window.setTimeout(function(){o._timer=0,o.list.length>0&&o.state==_.Free&&(o.state=e.TaskCountEvent.Busy,o.dispatch(new l(e.TaskCountEvent.Busy)))},1e3*this.deferSecond))),t},i.prototype._completeItem=function(t){var i=this.list.findIndex(function(e){return e.promise===t});return i>-1&&(this.list.splice(i,1),this.dispatch(new l(e.TaskCountEvent.Completed)),0==this.list.length&&(this._timer&&(clearTimeout(this._timer),this._timer=0),this.state==_.Busy&&(this.state=e.TaskCountEvent.Free,this.dispatch(new l(e.TaskCountEvent.Free))))),this},i}(f);e.TaskCounter=v;var m=new v(3);e.taskCounter=m;var C=function(t){return{}},y=function(t){function i(e,i,o){var n=t.call(this,i)||this;return n.view=e,n.vpid=o,n}return __extends(i,t),i.prototype.isWholeVPresenter=function(){return"function"==typeof this.getHeader&&"function"==typeof this.getFooter&&"function"==typeof this.getAside},i.prototype.init=function(t){return null},i.prototype._allowInstallTo=function(t){return!0},i.prototype._allowUninstallTo=function(t){return!0},i.prototype._allowAppendChild=function(t){return!0},i.prototype._allowRemoveChild=function(t){return!0},i.prototype._beforeInstallTo=function(t){},i.prototype._beforeUninstallTo=function(t){},i.prototype._afterInstallTo=function(t){},i.prototype._afterUninstallTo=function(t){},i.prototype._afterRemoveChild=function(t){this.view.removeChild(t.view)},i.prototype._afterAppendChild=function(t){this.view.appendChild(t.view)},i.prototype._beforeRemoveChild=function(t){},i.prototype._beforeAppendChild=function(t){},i.prototype._checkRemoveChild=function(t){return t.parent!=this||!(!t._allowUninstallTo(this)||!this._allowRemoveChild(t))},i.prototype.removeChild=function(t,i){return t.parent==this&&(!(!i&&!this._checkRemoveChild(t))&&(this._beforeRemoveChild(t),t._beforeUninstallTo(this),t.setParent(void 0),this._afterRemoveChild(t),t._afterUninstallTo(this),this.dispatch(new l(e.VPresenterEvent.ChildRemoved)),t.dispatch(new l(e.VPresenterEvent.Uninstalled)),!0))},i.prototype._checkAppendChild=function(t){return t.parent==this||!!(t._allowInstallTo(this)&&this._allowAppendChild(t)&&(!t.parent||t._allowUninstallTo(this)&&t.parent._allowRemoveChild(t)))},i.prototype.getParentDialog=function(){for(var t=this.parent;t;){if(t instanceof F)return t;t=t.parent}return P},i.prototype.appendChild=function(t,i){return t.parent!=this&&(!(!i&&!this._checkAppendChild(t))&&(t.parent&&t.parent.removeChild(t,!0),this._beforeAppendChild(t),t._beforeInstallTo(this),t.setParent(this),this._afterAppendChild(t),t._afterInstallTo(this),this.dispatch(new l(e.VPresenterEvent.ChildAppended)),t.dispatch(new l(e.VPresenterEvent.Installed)),!0))},i.prototype._update=function(){return Promise.resolve(this)},i.prototype.destroy=function(){this.vpid&&delete g[this.vpid]},i.prototype.getDialogClassName=function(){return""},i}(f);e.VPresenter=y;var g={};e.getVPresenter=o;var w;!function(t){t[t.Focused=0]="Focused",t[t.Blured=1]="Blured",t[t.Closed=2]="Closed"}(w=e.DialogState||(e.DialogState={}));var I;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right",t[t.Top=3]="Top",t[t.Middle=4]="Middle",t[t.Bottom=5]="Bottom"}(I=e.DialogPosition||(e.DialogPosition={}));var E;!function(t){t[t.Content=0]="Content",t[t.Full=1]="Full"}(E=e.DialogSize||(e.DialogSize={}));var F=function(t){function i(e,i){var o=t.call(this,e.view,void 0)||this;return o.history=new x,o.state=w.Closed,o.content=null,o._dialogList=[],o._zindex=-1,o.config={className:"",masked:!1,position:{x:I.Center,y:I.Middle},size:{width:"50%",height:"50%"},fixed:!0,offset:{x:0,y:0},effect:"",asideOnRight:!1,asideInBody:!1,headerEffect:void 0,footerEffect:void 0,asideEffect:void 0,bodyEffect:void 0,rootUriCmd:void 0},o.dialog=e.dialog,o.mask=e.mask,o.body=e.body,o.header=e.header,o.footer=e.footer,o.aside=e.aside,o.view.addClass("pt-"+w[o.state]),i&&o.setConfig(i),o}return __extends(i,t),i.prototype.setConfig=function(t){var e=this.config;this.config=Object.assign({},this.config,t),this._afterConfigChange(e)},i.prototype.getZIndex=function(){return this._zindex},i.prototype.getFocusedChild=function(){for(var t=this._dialogList,e=this;t.length;)e=t[t.length-1],t=e._dialogList;return e},i.prototype._afterConfigChange=function(t){this.view.removeClass([t.className,t.effect,t.masked?"pt-masked":"",t.asideOnRight?"pt-asideOnRight":"pt-asideOnLeft",t.asideInBody?"pt-asideInBody":"pt-asideOutBody"].join(" ")),this.view.addClass([this.config.className,this.config.effect,this.config.masked?"pt-masked":"",this.config.asideOnRight?"pt-asideOnRight":"pt-asideOnLeft",this.config.asideInBody?"pt-asideInBody":"pt-asideOutBody"].join(" "))},i.prototype._setZIndex=function(t){this._zindex=t,this.view.setZIndex(t)},i.prototype._countIndex=function(){this._dialogList.forEach(function(t,e){t._setZIndex(e)})},i.prototype._beforeFocus=function(){},i.prototype._afterFocus=function(){},i.prototype._beforeClose=function(){},i.prototype._afterClose=function(){},i.prototype._beforeBlur=function(){},i.prototype._afterBlur=function(){},i.prototype._allowFocus=function(t){return!0},i.prototype._allowBlur=function(){return!0},i.prototype._allowClose=function(){return!0},i.prototype._checkFocus=function(){if(this==P)return!0;if(!this.parent)return!1;var t=this.parent;if(this.state!=w.Focused){if(!this._allowFocus())return!1;var e=t._dialogList,i=e[e.length-1];if(i&&i!=this&&!i._allowBlur())return!1}return t._checkFocus()},i.prototype._checkClose=function(){if(this.state==w.Closed)return!0;if(!this.parent)return!1;if(!this._allowClose())return!1;var t=this.parent;if(this.state==w.Focused){var e=t._dialogList,i=e[e.length-2];if(i&&!i._allowFocus())return!1}return!0},i.prototype.focus=function(t,i){if(!t&&!this._checkFocus())return!1;var o=this.parent,n=o._dialogList,s=n[n.length-1],r=!0;if(this.state!=w.Focused&&(s==this&&(s=void 0,r=!1),this._beforeFocus(),r)){if(this.state==w.Blured){var h=n.indexOf(this);h>-1&&n.splice(h,1)}n.push(this),o._countIndex()}if(r&&o.focus(!1,!0),this.state!=w.Focused){s&&s._blur();var c=this.state;this._setState(w.Focused),c==w.Closed&&(this.refreshSize(),this.refreshPosition(),this.refreshLayout()),this._afterFocus(),i||a(this),this.dispatch(new l(e.DialogEvent.Focused)),this.content&&this.content.dispatch(new l(e.DialogEvent.Focused))}return!0},i.prototype.close=function(){if(this.state==w.Closed||!this._checkClose())return!1;this._beforeClose();var t=this.parent,i=t._dialogList,o=null;if(i[i.length-1]==this)i.pop(),o=i[i.length-1];else{var n=i.indexOf(this);n>-1&&i.splice(n,1),this._countIndex()}return this._setZIndex(-1),this._setState(w.Closed),this.refreshSize(),this.refreshPosition(),this.refreshLayout(),this._afterClose(),this.dispatch(new l(e.DialogEvent.Closed)),this.content&&this.content.dispatch(new l(e.DialogEvent.Closed)),o&&o.focus(!0),!o&&a(t),!0},i.prototype._blur=function(){this.state!=w.Blured&&(this._beforeBlur(),this._setState(w.Blured),this._afterBlur(),this.dispatch(new l(e.DialogEvent.Blured)),this.content&&this.content.dispatch(new l(e.DialogEvent.Blured)))},i.prototype._setState=function(t){this.view.removeClass("pt-"+w[this.state]),this.state=t,this.view.addClass("pt-"+w[this.state])},i.prototype._allowAppendChild=function(t){return!(t instanceof i&&t.state!=w.Closed)},i.prototype.appendChild=function(e){if(e.parent==this)return!1;if(!this._checkAppendChild(e))return!1;if(!(e instanceof i)){if(this.content){var o=this.content;if(o.parent!=this)return!1;if(!this._checkRemoveChild(o))return!1;this.removeChild(o,!0)}this.content=e}return t.prototype.appendChild.call(this,e,!0)},i.prototype._afterAppendChild=function(t){t instanceof i?this.view.appendChild(t.view):(this._contentClassName=t.getDialogClassName(),this.view.addClass(this._contentClassName),this.body?this.body.appendChild(t.view):this.dialog.appendChild(t.view),t.isWholeVPresenter()&&(this._contentHeader=t.getHeader(),this._contentHeader&&this.header&&this.header.appendChild(this._contentHeader),this._contentFooter=t.getFooter(),this._contentFooter&&this.footer&&this.footer.appendChild(this._contentFooter),this._contentAside=t.getAside(),this._contentAside&&this.aside&&this.aside.appendChild(this._contentAside)),this.state!=w.Closed&&(this.config.size.width==E.Content||this.config.size.height==E.Content?(this.refreshSize(),this.refreshPosition(),this.refreshLayout()):this.refreshLayout()))},i.prototype._afterRemoveChild=function(t){t instanceof i?this.view.removeChild(t.view):(this._contentClassName&&(this.view.removeClass(this._contentClassName),this._contentClassName=""),this.body?this.body.removeChild(t.view):this.dialog.removeChild(t.view),this._contentHeader&&this.header&&(this.header.removeChild(this._contentHeader),this._contentHeader=null),this._contentFooter&&this.footer&&(this.footer.removeChild(this._contentFooter),this._contentFooter=null),this._contentAside&&this.aside&&(this.aside.removeChild(this._contentAside),this._contentAside=null))},i.prototype.refreshSize=function(){},i.prototype.refreshPosition=function(){},i.prototype.refreshLayout=function(){},i}(y);e.Dialog=F;var T=function(t){function i(i,o){var n=t.call(this,i,o)||this;return n.initTime=Date.now(),n._setZIndex(0),n._setState(w.Focused),n.view.addClass("pt-topDialog"),m.addListener(e.TaskCountEvent.Added,function(t){n.mask.addClass("pt-show")}).addListener(e.TaskCountEvent.Completed,function(t){n.mask.removeClass("pt-show")}).addListener(e.TaskCountEvent.Busy,function(t){n.mask.addClass("pt-busy")}).addListener(e.TaskCountEvent.Free,function(t){n.mask.removeClass("pt-busy")}),o&&o.rootUriCmd&&n._initHistory(n.initTime,o.rootUriCmd),n}return __extends(i,t),i.prototype._initHistory=function(t,e){function i(t,e,i,o){window.history.pushState(t,e,o?i:"#"+encodeURI(i))}function o(e){window.history.replaceState(t+"."+e,document.title,window.location.href)}function s(e){var i=e.split(".").map(function(t){return parseInt(t)}),o=i[0],n=i[1],s=i[2];if(o==t){var r=c.getCmdByCode(n+"."+s);if(r){var h=c.getCode(),d=h[0],u=h[1],l=d-n+u-s;if(0!=l){var p=document.title;document.title=r.title,a=function(){document.title=p,setTimeout(function(){c.go(-l)},1)},window.history.go(l)}}else window.location.reload()}else window.location.reload()}function r(t){a?("function"==typeof a&&a(),a=!1):c.getLength()&&(t.state?s(t.state):(c.added(new k(window.location.href,document.title,(!1))),o(c.getCode().join("."))))}var a,h=!!window.history.pushState,c=this.history;c._syncHistory=function(e,o){var n=function(){e.push&&(i(t+"."+e.push.code,e.push.title,e.push.url,e.push.isUri),document.title=e.push.title),setTimeout(o,1)};e.move?(a=function(){document.title=e.moveTitle||"",n()},window.history.go(e.move)):n()},h?n(window,"popstate",r):n(window,"hashchange",function(t){console.log("hash",window.location.hash,t)}),c.added(e),o("1.0")},i.prototype.close=function(){return!1},i.prototype.focus=function(t){return!1},i}(F);e.Application=T;var P={};e.application=P;var k=function(t){function i(e,i,o){var n=t.call(this)||this;return n.url=e,n.title=i,n.isUri=o,n}return __extends(i,t),i.prototype.success=function(){this.dispatch(new l(e.CmdEvent.ItemSuccess,this,(!0)))},i.prototype.failure=function(){this.dispatch(new l(e.CmdEvent.ItemFailure,this,(!0)))},i.prototype.execute=function(){console.log(this.url,"execute"),this.success()},i.prototype.abort_execute=function(){},i.prototype.redo=function(){console.log(this.url,"redo"),this.success()},i.prototype.abort_redo=function(){},i.prototype.undo=function(){console.log(this.url,"undo"),this.success()},i.prototype.abort_undo=function(){},i}(f);e.Cmd=k;var x=function(t){function i(i){void 0===i&&(i=50);var o=t.call(this,void 0)||this;return o.maxStep=i,o._list=[],o._cache=[],o._cur=[0,0],o._goto=[0,0],o._first=[0,0],o._last=[0,0],o.addListener(e.CmdEvent.ItemSuccess,function(t){var e=t.target;e.setParent(void 0);var i=function(){o._curItem=void 0,o.next()},n=o._curItem;n&&(n.cur?(o._cur=n.cur,o._syncHistory({move:n.go,moveTitle:n.curCmd.title},i)):o._syncHistory(o._addHistoryItem(n.cmd),i))}).addListener(e.CmdEvent.ItemFailure,function(t){var e=t.target;e.setParent(void 0),o._curItem&&(o._goto=[o._cur[0],o._cur[1]],o._cache=[]),o._curItem=void 0}),o}return __extends(i,t),i.prototype.getLength=function(){return this._list.length},i.prototype.getCode=function(){return[this._cur[0],this._cur[1]]},i.prototype._pushState=function(t,e,i){window.history.pushState(t,"",i?e:"#"+encodeURI(e))},i.prototype._syncHistory=function(t,e){e()},i.prototype._addHistoryItem=function(t){var e=0,i="";if(this._cur.join(".")!=this._first.join(".")){this._list.splice(0,this._first[0]-this._cur[0]+this._first[0]-this._cur[1]);this._first=[this._cur[0],this._cur[1]]}if(t.isUri){if(0!=this._cur[1]){this._list.splice(0,this._cur[1]);e-=this._cur[1],this._cur[1]=0,this._goto[1]=0;var o=this.getCmdByCode(this._cur.join("."));i=o.title}this._cur[0]++,this._goto[0]++}else this._cur[1]++,this._goto[1]++;var n={code:this._cur.join("."),cmd:t};this._list.unshift(n),this._list.length>this.maxStep&&(this._list.length=this.maxStep),this._first=[this._cur[0],this._cur[1]];var s=this._list[this._list.length-1],r=s.code.split(".");return this._last=[parseInt(r[0]),parseInt(r[1])],{move:e,moveTitle:i,push:{code:n.code,url:t.url,title:t.title,isUri:t.isUri}}},i.prototype.getCmdByCode=function(t){var e=this._list.find(function(e){return e.code==t});return e?e.cmd:void 0},i.prototype.go=function(t){this._cache.push(t),this.next()},i.prototype.push=function(t){var e=Array.isArray(t)?t:[t];(i=this._cache).push.apply(i,e),this.next();var i},i.prototype.added=function(t){this._addHistoryItem(t)},i.prototype._executeGoto=function(){var t=this._goto,e=this._cur,i=t[0]-e[0];0==i?t[1]<e[1]?(this._curItem={cmd:this.getCmdByCode(e.join(".")),cur:[e[0],e[1]-1],curCmd:this.getCmdByCode([e[0],e[1]-1].join(".")),go:-1},this._curItem.cmd.setParent(this),this._curItem.cmd.undo()):(this._curItem={cmd:this.getCmdByCode([e[0],e[1]+1].join(".")),cur:[e[0],e[1]+1],curCmd:null,go:1},this._curItem.curCmd=this._curItem.cmd,this._curItem.cmd.setParent(this),this._curItem.cmd.redo()):(this._curItem={cmd:this.getCmdByCode([t[0],0].join(".")),cur:[t[0],0],curCmd:null,go:i-e[1]},this._curItem.curCmd=this._curItem.cmd,this._curItem.cmd.setParent(this),this._curItem.cmd.redo())},i.prototype._checkGoto=function(t){var e=[this._goto[0],this._goto[1]];if("number"==typeof t){if(t<0){var i=this._cur[1]+t;i<0?(e[0]+=i,e[1]=0):e[1]=i}else if(t>0){var i=e[0]+t-this._first[0];i>=0?(e[0]=this._first[0],e[1]+=i):e=[e[0]+t,0]}}else{var o=t.split(".");e=[parseInt(o[0]),parseInt(o[1])]}return e[0]>this._first[0]&&(e[0]=this._first[0]),e[0]<this._last[0]&&(e[0]=this._last[0]),e[0]==this._first[0]?e[1]>this._first[1]&&(e[1]=this._first[1]):e[1]=0,e},i.prototype.next=function(){if(!this._curItem)if(this._cur.join(".")!=this._goto.join("."))this._executeGoto();else{var t=this._cache.shift();t instanceof k?(this._curItem={cmd:t,cur:null,curCmd:null,go:0},t.setParent(this),t.execute()):t?(this._goto=this._checkGoto(t),this.next()):console.log("Complete",this._cur,this._goto,this._list)}},i}(f);e.History=x,e.initHistory=s,e.setConfig=r;var b;e.getTopDialog=h,e.bootstrap=c});