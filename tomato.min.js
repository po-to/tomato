var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};define(["require","exports"],function(t,e){"use strict";function i(t){return Object.keys(t).forEach(function(e){delete t[e]}),t}function n(e,i,o){var r,s;if("string"!=typeof e){s=e;var a=e.getVPID();r="string"==typeof a?a:a[0]}else s=null,r=e;var h=_[r];if(h instanceof v)return h;if(h instanceof Promise){var d=i||function(t){},l=o||function(t){};return h.then(d,l),h}var u=function(t,e){delete _[r],o&&o(t),e(t)},p=function(t,e,o,s){var a=null;try{a=new t(e,(void 0),r)}catch(t){u(t,s)}a&&Promise.all(e.getSUBS().map(function(t){return n(t)})).then(function(){i&&i(a),o(a)},function(t){u(t,s)})},f=new Promise(function(e,i){var n=function(n){var o=n.getVPCON(r);o?t([o],function(t){p(t,n,e,i)},function(t){u(t,i)}):p(v,n,e,i)};s?n(s):t([r],function(t){s="string"==typeof t?c(t):t,n(s)},function(t){u(t,i)})});return _[r]=f,f}function o(t){t.namespace&&(e.namespace=a=t.namespace),t.createVPView&&(c=t.createVPView),t.renderer&&(t.renderer.__parse__||(t.renderer.__parse__=function(t,e){for(var i in t.data)t.hasOwnProperty(i)&&t[i]&&t[i].type==e&&(t[i]=this.__parse__(t[i]));return this[t.renderer](t.template,t.data)}),define("rendererManager",t.renderer))}function r(){return E.getFocusedChild()}function s(t){t=t}var a="po-to/tomato";e.namespace=a,e.TaskCountEvent={Added:"TaskCountEvent.Added",Completed:"TaskCountEvent.Completed",Busy:"TaskCountEvent.Busy",Free:"TaskCountEvent.Free"},e.VPresenterEvent={Installed:"CPresenterEvent.Installed",Uninstalled:"CPresenterEvent.Uninstalled",ChildAppended:"CPresenterEvent.ChildAppended",ChildRemoved:"CPresenterEvent.ChildRemoved"},e.VPresenterTransaction={AllowInstall:"AllowInstall"},e.DialogEvent={Focused:"DialogEvent.Focused",Blured:"DialogEvent.Blured",Closed:"DialogEvent.Closed"};var h=function(){function t(t,e,i){void 0===i&&(i=!1),this.name=t,this.data=e,this.bubbling=i}return t.prototype._setTarget=function(t){return this.target=t,this},t}();e.PEvent=h;var d=function(){function t(t,e,i){void 0===e&&(e="tomato.PError"),this.name=t,this.note=e,this.data=i}return t.prototype.getNamespace=function(){return a},t}();e.PError=d;var l=function(){function t(t){this.parent=t,this._handlers={}}return t.prototype.addListener=function(t,e){var i=this._handlers[t];return i||(this._handlers[t]=i=[]),i.push(e),this},t.prototype.removeListener=function(t,e){if(t){var n=this._handlers;if(n.propertyIsEnumerable(t)){var o=n[t];if(e){var r=o.indexOf(e);r>-1&&o.splice(r,1),0==o.length&&delete n[t]}else delete n[t]}}else i(this._handlers);return this},t.prototype.dispatch=function(t){t.target||t._setTarget(this);var e=this._handlers[t.name];if(e)for(var i=0,n=e.length;i<n;i++)e[i](t);return this.parent&&t.bubbling&&this.parent.dispatch(t),this},t.prototype.setParent=function(t){return this.parent=t,this},t}();e.PDispatcher=l;var u;!function(t){t[t.Free=0]="Free",t[t.Busy=1]="Busy"}(u=e.TaskCounterState||(e.TaskCounterState={}));var p=function(t){function i(e){var i=t.call(this)||this;return i.deferSecond=e,i.list=[],i.state=u.Free,i}return __extends(i,t),i.prototype.addItem=function(t,i){var n=this;return this.list.find(function(e){return e.promise===t})||(this.list.push({promise:t,note:i}),t.then(function(e){return n._completeItem(t)},function(e){return n._completeItem(t)}),this.dispatch(new h(e.TaskCountEvent.Added)),this._timer||(this._timer=window.setTimeout(function(){n._timer=0,n.list.length>0&&n.state==u.Free&&(n.state=e.TaskCountEvent.Busy,n.dispatch(new h(e.TaskCountEvent.Busy)))},1e3*this.deferSecond))),this},i.prototype._completeItem=function(t){var i=this.list.findIndex(function(e){return e.promise===t});return i>-1&&(this.list.splice(i,1),this.dispatch(new h(e.TaskCountEvent.Completed)),0==this.list.length&&(this._timer&&(clearTimeout(this._timer),this._timer=0),this.state==u.Busy&&(this.state=e.TaskCountEvent.Free,this.dispatch(new h(e.TaskCountEvent.Free))))),this},i}(l);e.TaskCounter=p;var f=new p(3);e.taskCounter=f;var c=function(t){return{}},v=function(t){function i(e,i,n){var o=t.call(this,i)||this;return o.view=e,o.vpid=n,o}return __extends(i,t),i.prototype._allowInstallTo=function(t){return!0},i.prototype._allowUninstallTo=function(t){return!0},i.prototype._allowAppendChild=function(t){return!0},i.prototype._allowRemoveChild=function(t){return!0},i.prototype._installTo=function(i){t.prototype.setParent.call(this,i),this.dispatch(new h(e.VPresenterEvent.Installed))},i.prototype._uninstallTo=function(i){t.prototype.setParent.call(this,void 0),this.dispatch(new h(e.VPresenterEvent.Uninstalled))},i.prototype._afterRemoveChild=function(t){this.view.removeChild(t.view)},i.prototype._afterAppendChild=function(t){this.view.appendChild(t.view)},i.prototype._beforeRemoveChild=function(t){},i.prototype._beforeAppendChild=function(t){},i.prototype._checkRemoveChild=function(t){return t.parent!=this||!(!t._allowUninstallTo(this)||!this._allowRemoveChild(t))},i.prototype.removeChild=function(t,i){return t.parent==this&&(!(!i&&!this._checkRemoveChild(t))&&(this._beforeRemoveChild(t),t._uninstallTo(this),this._afterRemoveChild(t),this.dispatch(new h(e.VPresenterEvent.ChildRemoved)),!0))},i.prototype._checkAppendChild=function(t){return t.parent==this||!!(t._allowInstallTo(this)&&this._allowAppendChild(t)&&(!t.parent||t._allowUninstallTo(this)&&t.parent._allowRemoveChild(t)))},i.prototype.getParentDialog=function(){for(var t=this.parent;t;){if(t instanceof m)return t;t=t.parent}return E},i.prototype.appendChild=function(t,i){return t.parent!=this&&(!(!i&&!this._checkAppendChild(t))&&(t.parent&&t.parent.removeChild(t,!0),this._beforeAppendChild(t),t._installTo(this),this._afterAppendChild(t),this.dispatch(new h(e.VPresenterEvent.ChildAppended)),!0))},i.prototype._update=function(){return Promise.resolve(this)},i.prototype.destroy=function(){this.vpid&&delete _[this.vpid]},i}(l);e.VPresenter=v;var _={};e.getVPresenter=n;var C;!function(t){t[t.Focused=0]="Focused",t[t.Blured=1]="Blured",t[t.Closed=2]="Closed"}(C=e.DialogState||(e.DialogState={}));var y;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right",t[t.Top=3]="Top",t[t.Middle=4]="Middle",t[t.Bottom=5]="Bottom"}(y=e.DialogPosition||(e.DialogPosition={}));var g;!function(t){t[t.Content=0]="Content",t[t.Full=1]="Full"}(g=e.DialogSize||(e.DialogSize={}));var m=function(t){function i(e,i){var n=t.call(this,e.view,void 0)||this;return n.state=C.Closed,n.content=null,n._dialogList=[],n._zindex=-1,n.config={className:"",masked:!1,position:{x:y.Center,y:y.Middle},size:{width:"50%",height:"50%"},fixed:!0,offset:{x:0,y:0},effect:"",asideOnRight:!1,asideInBody:!1,headerEffect:void 0,footerEffect:void 0,asideEffect:void 0,bodyEffect:void 0},n.dialog=e.dialog,n.mask=e.mask,n.body=e.body,n.header=e.header,n.footer=e.footer,n.aside=e.aside,n.view.addClass("pt-"+C[n.state]),i&&n.setConfig(i),n}return __extends(i,t),i.prototype.setConfig=function(t){var e=this.config;this.config=Object.assign({},this.config,t),this._afterConfigChange(e)},i.prototype.getZIndex=function(){return this._zindex},i.prototype.getFocusedChild=function(){for(var t=this._dialogList,e=this;t.length;)e=t[t.length-1],t=e._dialogList;return e},i.prototype._afterConfigChange=function(t){this.view.removeClass([t.className,t.effect,t.masked?"pt-masked":"",t.asideOnRight?"pt-asideOnRight":"pt-asideOnLeft",t.asideInBody?"pt-asideInBody":"pt-asideOutBody"].join(" ")),this.view.addClass([this.config.className,this.config.effect,this.config.masked?"pt-masked":"",this.config.asideOnRight?"pt-asideOnRight":"pt-asideOnLeft",this.config.asideInBody?"pt-asideInBody":"pt-asideOutBody"].join(" "))},i.prototype._setZIndex=function(t){this._zindex=t,this.view.setZIndex(t)},i.prototype._countIndex=function(){this._dialogList.forEach(function(t,e){t._setZIndex(e)})},i.prototype._beforeFocus=function(){},i.prototype._afterFocus=function(){},i.prototype._beforeClose=function(){},i.prototype._afterClose=function(){},i.prototype._beforeBlur=function(){},i.prototype._afterBlur=function(){},i.prototype._allowFocus=function(t){return!0},i.prototype._allowBlur=function(){return!0},i.prototype._allowClose=function(){return!0},i.prototype._checkFocus=function(){if(this==E)return!0;if(!this.parent)return!1;var t=this.parent;if(this.state!=C.Focused){if(!this._allowFocus())return!1;var e=t._dialogList,i=e[e.length-1];if(i&&i!=this&&!i._allowBlur())return!1}return t._checkFocus()},i.prototype._checkClose=function(){if(this.state==C.Closed)return!0;if(!this.parent)return!1;if(!this._allowClose())return!1;var t=this.parent;if(this.state==C.Focused){var e=t._dialogList,i=e[e.length-2];if(i&&!i._allowFocus())return!1}return!0},i.prototype.focus=function(t){if(!t&&!this._checkFocus())return!1;var i=this.parent,n=i._dialogList,o=n[n.length-1],r=!0;if(this.state!=C.Focused&&(o==this&&(o=void 0,r=!1),this._beforeFocus(),r)){if(this.state==C.Blured){var s=n.indexOf(this);s>-1&&n.splice(s,1)}n.push(this),i._countIndex()}if(r&&i.focus(),this.state!=C.Focused){o&&o._blur();var a=this.state;this._setState(C.Focused),a==C.Closed&&(this.refreshSize(),this.refreshPosition(),this.refreshLayout()),this._afterFocus(),this.dispatch(new h(e.DialogEvent.Focused))}return!0},i.prototype.close=function(){if(this.state==C.Closed||!this._checkClose())return!1;this._beforeClose();var t=this.parent,i=t._dialogList,n=null;if(i[i.length-1]==this)i.pop(),n=i[i.length-1];else{var o=i.indexOf(this);o>-1&&i.splice(o,1),this._countIndex()}return this._setZIndex(-1),this._setState(C.Closed),this.refreshSize(),this.refreshPosition(),this.refreshLayout(),this._afterClose(),this.dispatch(new h(e.DialogEvent.Closed)),n&&n.focus(!0),!0},i.prototype._blur=function(){this.state!=C.Blured&&(this._beforeBlur(),this._setState(C.Blured),this._afterBlur(),this.dispatch(new h(e.DialogEvent.Blured)))},i.prototype._setState=function(t){this.view.removeClass("pt-"+C[this.state]),this.state=t,this.view.addClass("pt-"+C[this.state])},i.prototype._allowAppendChild=function(t){return!(t instanceof i&&t.state!=C.Closed)},i.prototype.appendChild=function(e){if(e.parent==this)return!1;if(!this._checkAppendChild(e))return!1;if(!(e instanceof i)){this.content;if(this.content){var n=this.content;if(n.parent!=this)return!1;if(!this._checkRemoveChild(n))return!1;this.removeChild(n,!0)}this.content=e}return t.prototype.appendChild.call(this,e,!0)},i.prototype._afterAppendChild=function(t){if(t instanceof i)this.view.appendChild(t.view);else{if(this.body?this.body.appendChild(t.view):this.dialog.appendChild(t.view),t instanceof w){var e=t.getHeader();e&&this.header&&this.header.appendChild(e),e=t.getFooter(),e&&this.footer&&this.footer.appendChild(e),e=t.getAside(),e&&this.aside&&this.aside.appendChild(e)}this.state!=C.Closed&&(this.config.size.width==g.Content||this.config.size.height==g.Content?(this.refreshSize(),this.refreshPosition(),this.refreshLayout()):this.refreshLayout())}},i.prototype._afterRemoveChild=function(t){if(t instanceof i)this.view.removeChild(t.view);else if(this.body?this.body.removeChild(t.view):this.dialog.removeChild(t.view),t instanceof w){var e=t.getHeader();e&&this.header&&this.header.removeChild(e),e=t.getFooter(),e&&this.footer&&this.footer.removeChild(e),e=t.getAside(),e&&this.aside&&this.aside.removeChild(e)}},i.prototype.refreshSize=function(){},i.prototype.refreshPosition=function(){},i.prototype.refreshLayout=function(){},i}(v);e.Dialog=m;var w=function(t){function e(){return t.apply(this,arguments)||this}return __extends(e,t),e.prototype.getHeader=function(){return null},e.prototype.getFooter=function(){return null},e.prototype.getAside=function(){return null},e}(v);e.WholeVPresenter=w;var k=function(t){function i(i,n){var o=t.call(this,i,n)||this;return o._setZIndex(0),o._setState(C.Focused),f.addListener(e.TaskCountEvent.Added,function(t){o.mask.removeClass("pt-hide").addClass("pt-show")}).addListener(e.TaskCountEvent.Busy,function(t){o.mask.addClass("pt-busy")}).addListener(e.TaskCountEvent.Free,function(t){o.mask.removeClass("pt-show pt-busy").addClass("pt-hide")}),o}return __extends(i,t),i.prototype.close=function(){return!1},i.prototype.focus=function(t){return!1},i}(m);e.Application=k;var E={};e.application=E,e.setConfig=o,e.getFocusedChild=r,e.bootstrap=s});